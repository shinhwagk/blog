---
layout: post
title: "使用自定义hosts、自签证书，来使用kaniko构建镜像 push到 nexus docker registry"
categories: misc
---

```sh
docker run -it --rm  
-v /etc/hosts:/etc/hosts \
-v /etc/nsswitch.conf:/etc/nsswitch.conf \
-v /etc/pki/ca-trust/source/anchors/gk.crt:/kaniko/ssl/certs/gk.crt \
-v /root/.docker/config.json:/kaniko/.docker/config.json \
-v /tmp/test:/opt --entrypoint=/busybox/sh \
gcr.io/kaniko-project/executor:debug

# 容器内输入
/kaniko/executor --dockerfile=/opt/Dockerfile -context=/opt --destination=gk.io/centos:121 --verbosity=debug

```

### 这里为什么需要导入/etc/nsswitch.conf这个文件？
> 因为构建kaniko的镜像，不包含这个文件，这个文件，用来告知应用或linux，应该如何来解析域名
> 如果这个文件不存在，那么默认dns解析行为就是
```
hosts    dns [!UNAVAIL=return] files
```
> 什么意思？ 就是说 dns服务器没有返回不可用，那么就用dns，注意这不是一层层试下来的规则，当dns可用，但是dns不能解析某个域名时，是不会去用files，也就是/etc/hosts,即使hosts文件中定义了如何解析。

https://github.com/GoogleContainerTools/kaniko/issues/612
https://github.com/golang/go/issues/22846